---
description: Enforce 100% coverage on all code
globs: ["src/**/*.{ts,js,py,jsx,tsx}"]
alwaysApply: true
---

# SonarQube Coverage Rule

## Target Metrics
- **Coverage**: 100% (Statements, Branches, Functions, Lines)
- **Duplication**: < 3% (aim for 0%)
- **Maintainability**: Grade A
- **Reliability**: Grade A

## Mandatory Test Requirements
- **100% Line Coverage**: Every line of code must be executed in tests
- **100% Branch Coverage**: Test every `if`, `else`, `switch` case, `catch` block, ternary operator
- **100% Function Coverage**: Every exported function must be tested
- **Edge Cases Required**: Always test `null`, `undefined`, `[]`, `""`, `0`, negative numbers, boundary conditions

## Test Structure Requirements
- One test file per source file: `SourceFile.test.js` for `SourceFile.js`
- Group related tests using `describe` blocks
- Use descriptive test names: `should [expected behavior] when [condition]`
- Follow Arrange-Act-Assert pattern

## Mocking Strategy
- **Mock all external dependencies**: APIs, services, database, file system
- **Use fake timers**: Never use real `setTimeout`, `setInterval`, or `Date` in tests
- **Mock network calls**: Use realistic mock responses
- **Isolate tests**: Each test should be independent and isolated

## Code Quality Standards
- **No Duplication**: Extract common test logic to shared utilities
- **Maintainable**: Tests should be clear, organized, and easy to understand
- **Reliable**: Tests must pass consistently (no flakiness)
- **Non-Breaking**: Never modify core functionality when writing tests

## Edge Case Checklist
For every function, test:
- [ ] `null` input
- [ ] `undefined` input
- [ ] Empty string `""`
- [ ] Empty array `[]`
- [ ] Zero `0`
- [ ] Negative numbers
- [ ] Boundary conditions (min/max values)
- [ ] Invalid inputs
- [ ] Error conditions

## Verification
- Run `npm test` or `npm run test:coverage` to verify coverage
- Check that coverage is 100% for the file being tested
- Ensure all tests pass consistently
- Verify no core functionality was modified

## SonarQube Path Normalization Workflow

### Critical Requirement
**All coverage files MUST use paths relative to project root with forward slashes** for SonarQube to correctly match coverage data to source files.

### Path Format Requirements
- **Frontend files**: Must use `frontend/src/...` (NOT `src/...` or absolute Windows paths)
- **Backend files**: Must use `backend/...` (NOT relative paths from backend directory)
- **Path separators**: Must use forward slashes `/` (NOT backslashes `\`)
- **Example correct paths**:
  - ✅ `SF:frontend/src/components/AddInvestigationResultModal.jsx`
  - ✅ `SF:backend/controllers/exportController.js`
  - ❌ `SF:src/components/AddInvestigationResultModal.jsx` (missing `frontend/` prefix)
  - ❌ `SF:D:\Work Files\latesturology\frontend\src\...` (absolute Windows path)

### Required Workflow

**Always use `generate-coverage-and-scan.bat` script** which automates the entire process:

1. **Generate Coverage**: Runs `npm run test:coverage` for both frontend and backend
2. **Normalize Paths**: Automatically runs `node scripts/fix-lcov-paths.js` to fix all paths
3. **Run SonarQube Scan**: Executes the SonarQube scanner

**Manual Process** (if script is not available):
1. Run tests with coverage:
   ```bash
   cd frontend && npm run test:coverage -- --run
   cd backend && npm run test:coverage
   ```
2. **CRITICAL**: Run path normalization script:
   ```bash
   node scripts/fix-lcov-paths.js
   ```
3. Run SonarQube scan:
   ```bash
   sonar-scanner.bat -D"sonar.projectKey=uroprep" ...
   ```

### Why Path Normalization is Needed

- Vitest/Jest generate coverage with paths relative to their working directory (`src/...` for frontend)
- SonarQube expects paths relative to project root (`frontend/src/...`)
- Windows uses backslashes which SonarQube doesn't handle well
- Without normalization, SonarQube shows 0% coverage even when tests exist

### How `fix-lcov-paths.js` Works

The script:
1. Reads `frontend/coverage/lcov.info` and `backend/coverage/lcov.info`
2. Converts `SF:src/...` → `SF:frontend/src/...` for frontend files
3. Converts `SF:controllers/...` → `SF:backend/controllers/...` for backend files
4. Normalizes all backslashes to forward slashes
5. Handles absolute Windows paths by extracting relative paths
6. Preserves existing correct paths

### Verification Steps

After running `fix-lcov-paths.js`, verify paths are correct:

```bash
# Check frontend paths
grep "^SF:frontend/src/" frontend/coverage/lcov.info | head -5

# Check backend paths  
grep "^SF:backend/" backend/coverage/lcov.info | head -5

# Verify no incorrect paths exist
grep "^SF:src/" frontend/coverage/lcov.info  # Should return nothing
grep "^SF:D:" frontend/coverage/lcov.info    # Should return nothing (no absolute paths)
```

### Common Issues and Solutions

**Issue**: SonarQube shows 0% coverage for files that have tests
- **Solution**: Run `node scripts/fix-lcov-paths.js` before scanning

**Issue**: "Found X inconsistencies in coverage report"
- **Solution**: Paths don't match SonarQube's file list - ensure paths use `frontend/src/` or `backend/` prefix

**Issue**: Coverage drops after regenerating
- **Solution**: Always run path normalization script after generating coverage

### Best Practices

1. **Always use `generate-coverage-and-scan.bat`** - it handles everything automatically
2. **Never commit `lcov.info` files** - they're generated artifacts
3. **Run path normalization** before every SonarQube scan
4. **Verify paths** in `lcov.info` match `sonar.sources` in `sonar-project.properties`
5. **Check SonarQube logs** for "inconsistencies" - indicates path mismatches